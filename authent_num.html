<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myme - Vérification Téléphone</title>
    <style>
        :root {
            --myme-blue: #0866ff;
            --myme-bg-light: #f0f2f5;
        }

        body {
            font-family: 'Century Gothic', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--myme-blue);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Container Principal */
        .auth-container {
            display: flex;
            width: 90%;
            max-width: 900px;
            height: 550px;
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        /* Côté Visuel (PC) */
        .visual-side {
            flex: 1;
            background-color: var(--myme-bg-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .visual-side img {
            width: 220px;
            height: 220px;
            object-fit: contain;
            margin-bottom: 20px;
        }

        /* Côté Formulaire (PC) */
        .form-side {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .fleche-retour {
            position: absolute; top: 20px; left: 20px; width: 40px; height: 40px;
            background: none; border: none; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }
        .fleche-retour::after {
            content: ''; width: 10px; height: 10px;
            border-left: 3px solid #ccc; border-bottom: 3px solid #ccc;
            transform: rotate(45deg);
        }

        h1 { color: var(--myme-blue); margin-bottom: 10px; font-size: 24px; }
        p.subtitle { color: #65676b; margin-bottom: 30px; font-size: 14px; }

        .input-group { width: 100%; margin-bottom: 20px; }

        select.country-select {
            width: 100%; height: 45px; border-radius: 12px;
            border: 2px solid #eee; padding: 0 10px; margin-bottom: 10px;
            font-family: inherit; font-size: 15px; outline: none;
        }

        .phone-wrapper {
            display: flex; gap: 10px;
        }

        .prefix-box {
            width: 70px; height: 45px; border-bottom: 2px solid var(--myme-blue);
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: #1c1e21;
        }

        .num-input {
            flex: 1; height: 45px; border: none;
            border-bottom: 2px solid var(--myme-blue);
            font-size: 18px; outline: none; letter-spacing: 1px;
        }

        .btn-next {
            background-color: var(--myme-blue); color: white;
            padding: 15px; border-radius: 15px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
            margin-top: 20px; transition: 0.3s;
        }
        .btn-next:hover { background-color: #0052d1; transform: translateY(-2px); }
        .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }

        #error { font-size: 13px; font-weight: bold; margin-top: 15px; min-height: 20px; }

        /* Responsive */
        @media (max-width: 800px) {
            .auth-container { flex-direction: column; height: auto; width: 95%; margin: 20px; }
            .visual-side { padding: 30px 20px; }
            .form-side { padding: 40px 20px; }
            .visual-side img { width: 150px; height: 150px; }
        }
    </style>
</head>
<body>

    <div class="auth-container">
        <div class="visual-side">
            <img src="img_num.jpg" alt="Security Illustration">
            <p style="color: #919191; font-size: 12px; max-width: 250px;">
                La sécurité de votre compte est notre priorité. MyMe utilise votre numéro pour vous connecter avec vos proches.
            </p>
        </div>

        <div class="form-side">
            <button class="fleche-retour" onclick="window.history.back()"></button>

            <h1 data-lang="welcome">Bienvenue</h1>
            <p class="subtitle" data-lang="enter_phone">Veuillez entrer votre numéro de téléphone</p>

            <div class="input-group">
                <select class="country-select" id="country" onchange="document.getElementById('prefix-val').textContent = this.value">
                    <option value="213">Algérie (+213)</option>
                    <option value="226">Burkina Faso (+226)</option>
                    <option value="237">Cameroun (+237)</option>
                    <option value="212">Maroc (+212)</option>
                    <option value="223">Mali (+223)</option>
                    <option value="243" selected>RD Congo (+243)</option>
                    <option value="242">République du Congo (+242)</option>
                    <option value="255">Tanzanie (+255)</option>
                    <option value="216">Tunisie (+216)</option>
                </select>

                <div class="phone-wrapper">
                    <div class="prefix-box">
                        <span>+</span><span id="prefix-val">243</span>
                    </div>
                    <input type="tel" id="phone-number" class="num-input" placeholder="Numéro" data-lang="phone_placeholder" maxlength="10">
                </div>
            </div>

            <button class="btn-next" id="btn-submit">
                <span data-lang="next">Suivant</span>
            </button>

            <p id="error"></p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, getDoc, 
        collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA3YTGXBA9Cf9QNaGau0PCBgyuGSJv5pi0",
        authDomain: "myme-31f3c.firebaseapp.com",
        projectId: "myme-31f3c",
        storageBucket: "myme-31f3c.firebasestorage.app",
        messagingSenderId: "598768810366",
        appId: "1:598768810366:web:b401c77010102e8988db2f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const errorDisplay = document.getElementById("error");
    const phoneInput = document.getElementById('phone-number');
    const btnSubmit = document.getElementById('btn-submit');
    const countrySelect = document.getElementById('country');

    // Vérification Session
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userSnap = await getDoc(doc(db, "users", user.uid));
            if (userSnap.exists() && userSnap.data().telephone) {
                window.location.href = 'ACCEUIL.html';
            }
        } else {
            window.location.href = 'authent.html';
        }
    });

    // Filtre numérique uniquement
    phoneInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    async function applyTranslations() {
        const lang = localStorage.getItem("lang") || "fr";
        try {
            const res = await fetch("lang.json");
            const data = await res.json();
            document.querySelectorAll("[data-lang]").forEach(el => {
                const key = el.getAttribute("data-lang");
                if (data[lang]?.[key]) {
                    if (el.tagName === "INPUT") el.placeholder = data[lang][key];
                    else el.textContent = data[lang][key];
                }
            });
        } catch (e) { console.warn("Erreur langues non trouvées"); }
    }

    btnSubmit.addEventListener('click', async () => {
        const user = auth.currentUser;
        if(!user) return;

        let number = phoneInput.value.trim();
        if (number.startsWith('0')) number = number.substring(1);
        const fullPhoneNumber = "+" + countrySelect.value + number;

        if (number.length < 7) {
            errorDisplay.textContent = "Numéro trop court";
            errorDisplay.style.color = "red";
            return;
        }

        try {
            btnSubmit.disabled = true;
            errorDisplay.textContent = "Vérification...";
            errorDisplay.style.color = "orange";

            // Vérifier unicité
            const q = query(collection(db, "users"), where("telephone", "==", fullPhoneNumber));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                errorDisplay.textContent = "Ce numéro est déjà lié à un autre compte.";
                errorDisplay.style.color = "red";
                btnSubmit.disabled = false;
                return;
            }

            // Enregistrement
            await setDoc(doc(db, "users", user.uid), {
                telephone: fullPhoneNumber,
                updatedAt: new Date()
            }, { merge: true });

            window.location.href = 'profil.html';

        } catch (e) {
            errorDisplay.textContent = "Erreur de connexion.";
            errorDisplay.style.color = "red";
            btnSubmit.disabled = false;
        }
    });

    applyTranslations();
</script>
</body>
</html>
