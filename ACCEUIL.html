<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Rock+Salt&family=Caveat:wght@400;700&family=Shadows+Into+Light&family=Gochi+Hand&display=swap" rel="stylesheet">
    <title>Myme - Accueil</title>
    <style>
/* --- VARIABLES UNIFIÃ‰ES --- */
:root {
    --bg: #ffffff;
    --text: #1c1e21;
    --gray: #65676b;
    --myme-blue: #0088ff;
    --hover-bg: #f2f2f2;
    --card-border: #f0f2f5;
    --sidebar-mini: #f7f8fa;
    --app-font-family: 'Segoe UI', system-ui, sans-serif;

    /* WhatsApp Dark Mode */
    --wa-bg-mini: #202c33;
    --wa-bg-main: #111b21;
    --wa-bg-chat: #0b141a;
    --wa-text-primary: #e9edef;
    --wa-text-secondary: #8696a0;
    --wa-green: #00a884;
    --wa-border: #222d34;
}

body.dark-mode {
    --bg: var(--wa-bg-main);
    --text: var(--wa-text-primary);
    --gray: var(--wa-text-secondary);
    --hover-bg: #2b3943;
    --card-border: var(--wa-border);
    --sidebar-mini: var(--wa-bg-mini);
    --myme-blue: var(--wa-green);
}

body {
    font-family: var(--app-font-family);
    background: var(--bg);
    color: var(--text);
    margin: 0;
    height: 100vh;
    overflow: hidden;
}

.app-container { display: flex; height: 100vh; width: 100vw; }

/* --- 1. BARRE MINI (EXTRÃŠME GAUCHE) --- */
.sidebar-mini {
    width: 65px;
    background: var(--sidebar-mini);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 15px 0;
    border-right: 1px solid var(--card-border);
    justify-content: space-between;
}

.mini-nav-vertical {
    display: flex;
    flex-direction: column;
    gap: 22px;
    align-items: center;
}

/* Style Contour Gris Pro */
.mini-nav-vertical svg, .settings-icon svg {
    width: 24px;
    height: 24px;
    stroke: #8696a0;
    fill: none;
    stroke-width: 2px;
    transition: 0.3s;
    cursor: pointer;
}

.mini-nav-vertical .active svg {
    stroke: var(--myme-blue);
    stroke-width: 2.5px;
}

.mini-nav-vertical a:hover svg, .settings-icon:hover svg {
    stroke: var(--text);
    transform: scale(1.1);
}

/* Bouton Ajouter */
.add-btn {
    background: var(--myme-blue);
    border: none;
    /* Arrondi moderne (style application) mais pas rond */
    border-radius: 12px; 
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: 0.2s;
    padding: 0; /* Ã‰vite les dÃ©calages */
}

.add-btn svg {
    width: 20px;
    height: 20px;
    /* Force le plus en blanc pur */
    stroke: #ffffff !important; 
    stroke-width: 3px;
    fill: none;
}

.add-btn:hover {
    background: #0077e6; /* Un bleu un peu plus sombre au survol */
    transform: scale(1.05);
}
/* Section Profil et ParamÃ¨tres en bas */
.profile-section-bottom {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    padding-bottom: 10px;
}

.user-avatar-header {
    width: 40px; height: 40px; border-radius: 50%;
    object-fit: cover; cursor: pointer; border: 2px solid transparent;
}

/* --- 2. COLONNE DISCUSSIONS (NOM MYME ICI) --- */
.sidebar-main {
    width: 380px;
    display: flex;
    flex-direction: column;
    background: var(--bg);
    border-right: 1px solid var(--card-border);
}

.sidebar-header {
    padding: 20px 20px 10px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-header h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
    letter-spacing: -0.5px;
}

.search-container { padding: 10px 15px; }
.search-bar {
    width: 100%; box-sizing: border-box; padding: 10px 15px;
    border-radius: 8px; border: none;
    background: var(--sidebar-mini); color: var(--text); outline: none;
}

.chat-item {
    display: flex; height: 72px; padding: 0 15px; align-items: center; cursor: pointer;
    border-bottom: 1px solid var(--card-border);
}
.chat-item:hover { background: var(--hover-bg); }

/* --- 3. VUE CHAT --- */
.main-chat-view { flex: 1; position: relative; background: var(--bg); }

body.dark-mode .main-chat-view::before {
    content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
    background-repeat: repeat; background-size: 400px; opacity: 0.05; z-index: 0;
}

#chat-iframe { width: 100%; height: 100%; border: none; position: relative; z-index: 1; }

#dropdown-menu {
    position: absolute; bottom: 80px; left: 70px; background: var(--bg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2); border-radius: 12px;
    display: none; flex-direction: column; width: 200px; z-index: 1000;
    border: 1px solid var(--card-border);
}
.menu-item { padding: 12px 15px; cursor: pointer; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
.menu-item:hover { background: var(--hover-bg); }

    </style>
</head>
<body onclick="closeMenu()">

<div class="app-container">
    <nav class="sidebar-mini">
        <div class="mini-nav-vertical">
            <a href="ACCEUIL.html" class="active" title="Discussions">
                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </a>
            <a href="javascript:void(0)" onclick="openSettingsInChat('appel.html')" title="Appels">
                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
            </a>
            <button class="add-btn" onclick="location.href='contacts.html'">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="white" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
        </div>

        <div class="profile-section-bottom">
            <div class="settings-icon"
                onclick="openSettingsInChat('parametres.html')"
                style="margin-bottom: 5px; cursor: pointer;"
                title="ParamÃ¨tres">
                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
            <div style="position:relative;">
                <img id="headerUserImg" class="user-avatar-header" src="https://ui-avatars.com/api/?name=?" onclick="toggleMenu(event)">
                <div id="self-online-dot" style="position:absolute; bottom:0; right:0; width:12px; height:12px; background:#00a884; border:2px solid var(--sidebar-mini); border-radius:50%;"></div>
            </div>
        </div>
    </nav>

    <aside class="sidebar-main">
        <div class="sidebar-header">
            <h1>Myme</h1> </div>

        <div class="search-container">
            <input type="text" class="search-bar" id="search-input" placeholder="Rechercher une discussion">
        </div>

        <div class="sidebar-content">
            <div class="chat-list" id="chat-container"></div>
            <div id="empty-state" style="display:none; flex-direction:column; align-items:center; margin-top:50px;">
                <p style="color:var(--gray);">Aucune discussion</p>
            </div>
        </div>
    </aside>

    <main class="main-chat-view">
        <div id="no-chat-welcome" class="no-chat-selected" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--gray);">
            <svg viewBox="0 0 24 24" width="80" height="80" style="opacity: 0.1; margin-bottom: 15px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
            <p>SÃ©lectionnez une discussion pour commencer</p>
        </div>
        <iframe id="chat-iframe" name="chat-frame" style="display:none;"></iframe>

        <div id="dropdown-menu">
            <div class="menu-item" onclick="openSettingsInChat('parametres.html')">ParamÃ¨tres</div>
            <div class="menu-item" onclick="openSettingsInChat('fond_ecran.html')">Personnalisation</div>
            <div class="menu-item">
                <span>Mode Sombre</span>
                <label class="switch">
                    <input type="checkbox" id="theme-switch" onchange="toggleTheme()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="menu-item" style="color: #ff4d4d;" onclick="logout()">DÃ©connexion</div>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
        initializeFirestore,
        persistentLocalCache,
        collection,
        query,
        onSnapshot,
        getDoc,
        doc,
        collectionGroup,
        where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. PATCH POUR CAPACITOR (Ã‰vite l'erreur sur le module '@capacitor/app')
    const App = window.App || {
        addListener: () => console.log("App listener simulÃ© sur le Web"),
        exitApp: () => console.log("Sortie d'app simulÃ©e")
    };


    const firebaseConfig = {
        apiKey: "AIzaSyA3YTGXBA9Cf9QNaGau0PCBgyuGSJv5pi0",
        authDomain: "myme-31f3c.firebaseapp.com",
        projectId: "myme-31f3c",
        storageBucket: "myme-31f3c.firebasestorage.app",
        messagingSenderId: "598768810366",
        appId: "1:598768810366:web:b401c77010102e8988db2f"
    };
    async function setupBackButton() {
        await App.addListener('backButton', ({ canGoBack }) => {
            if (window.location.pathname.includes('ACCEUIL.html') || !canGoBack) {
                App.exitApp();
            }else {
                window.history.back();
            }
        });
    }
    setupBackButton();

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const db = initializeFirestore(app, {
        localCache: persistentLocalCache()
    });
    window.openChat = (uid) => {
        const iframe = document.getElementById('chat-iframe');
        const welcome = document.getElementById('no-chat-welcome');

        iframe.src = `chat.html?uid=${uid}`;
        iframe.style.display = 'block';
        welcome.style.display = 'none';
    };

    // --- VARIABLES DE CONTRÃ”LE ---
    let isRendering = false; // Le "verrou" pour Ã©viter les doublons

    window.toggleMenu = (e) => {
        e.stopPropagation();
        const m = document.getElementById('dropdown-menu');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    };
    (function applyStyleImmediately() {
        const fs = localStorage.getItem('myme-fsize') || '16px';
        const ff = localStorage.getItem('myme-ffam') || "'Segoe UI'";
        const rad = localStorage.getItem('myme-radius') || '25px';
        const theme = localStorage.getItem('theme');

        document.documentElement.style.setProperty('--app-font-size', fs);
        document.documentElement.style.setProperty('--app-font-family', ff);
        document.documentElement.style.setProperty('--app-radius', rad);

        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
        }
    })();
    window.closeMenu = () => {
        const m = document.getElementById('dropdown-menu');
        if(m) m.style.display = 'none';
    }

    window.toggleTheme = () => {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    window.openSettingsInChat = (page) => {
        console.log("Tentative d'ouverture de :", page); // Pour vÃ©rifier dans la console (F12)
    
        const iframe = document.getElementById('chat-iframe');
        const welcome = document.getElementById('no-chat-welcome');

        if (iframe) {
            iframe.src = page;
            iframe.style.display = 'block';
        
            // Cache le message de bienvenue si prÃ©sent
            if (welcome) {
                welcome.style.display = 'none';
            }
        } else {
            console.error("L'Ã©lÃ©ment 'chat-iframe' est introuvable !");
        }
    };

    window.logout = async () => {
        try {
            // 1. On dÃ©connecte Firebase
            await signOut(auth);

            window.location.href = "authent.html";
        } catch (error) {
            console.error("Erreur lors de la dÃ©connexion:", error);
            // Au cas oÃ¹ Firebase bug, on force quand mÃªme le nettoyage local
            localStorage.clear();
            window.location.href = "authent.html";
        }
    };
    // Exemple Ã  adapter dans ta page ACCEUIL.html
    function ecouterMessagesNonLus(monUid, contactUid, elementBadgeId) {
        const chatId = monUid < contactUid ? `${monUid}_${contactUid}` : `${contactUid}_${monUid}`;
        const q = query(
            collection(db, "chats", chatId, "messages"),
            where("receiverId", "==", monUid),
            where("read", "==", false)
        );

        onSnapshot(q, (snap) => {
            const count = snap.size;
            const badge = document.getElementById(elementBadgeId);
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = "flex"; // Affiche le rond rouge
            } else {
                badge.style.display = "none"; // Cache si tout est lu
            }
        });
    }
    function ecouterTotalMessagesNonLus(myUid) {
        const qGlobal = query(
            collectionGroup(db, "messages"),
            where("receiverId", "==", myUid),
            where("read", "==", false)
        );

        onSnapshot(qGlobal, (snap) => {
            const total = snap.size;
            const globalBadge = document.getElementById('global-unread-badge');

            if (total > 0) {
                globalBadge.textContent = total > 15 ? "15+" : total;
                globalBadge.style.display = "flex";
            } else {
                globalBadge.style.display = "none";
            }
        });
    }

// Dans ton bloc <script type="module">

    function syncMymeStyle() {
        const fs = localStorage.getItem('myme-fsize') || '16px';
        const ff = localStorage.getItem('myme-ffam') || "'Segoe UI'";
        const rad = localStorage.getItem('myme-radius') || '25px';
        const theme = localStorage.getItem('theme');

    // Appliquer les variables CSS
        document.documentElement.style.setProperty('--app-font-size', fs);
        document.documentElement.style.setProperty('--app-font-family', ff);
        document.documentElement.style.setProperty('--app-radius', rad);

    // GÃ©rer le mode sombre
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            const ts = document.getElementById('theme-switch');
            if(ts) ts.checked = true;
        } else {
            document.body.classList.remove('dark-mode');
            const ts = document.getElementById('theme-switch');
            if(ts) ts.checked = false;
        }
    }

// Appelle syncMymeStyle() dÃ¨s le dÃ©but du script module
    syncMymeStyle();

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "authent.html";
            return;
        }
        ecouterTotalMessagesNonLus(user.uid);
        // --- AJOUT : Charger la photo dans le header ---
        onSnapshot(doc(db, "users", user.uid), (snap) => {
            if (snap.exists()) {
                const userData = snap.data();
                const headerImg = document.getElementById('headerUserImg');
                const onlineDot = document.getElementById('self-online-dot');

                // Mise Ã  jour de la photo
                if (userData.photoURL) {
                    headerImg.src = userData.photoURL;
                } else {
                    headerImg.src = `https://ui-avatars.com/api/?name=${userData.prenom}+${userData.nom}&background=0866ff&color=fff`;
                }

                // Gestion du point de statut (optionnel : l'afficher seulement si on est connectÃ©)
                if (userData.isOnline) {
                    onlineDot.style.display = 'block';
                } else {
                    onlineDot.style.display = 'none';
                }
            }
        });
        syncMymeStyle();
        applyTranslations();
        // On utilise OneSignal (Gratuit)
        initialiserNotifications(user.uid);
        initMessagesListener(user.uid);
    });
    async function initialiserNotifications(userUid) {
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(async function() {
            try {
                await OneSignal.init({
                    appId: "bc89bfa9-801e-4bd0-a178-314064e44f7d",
                    notifyButton: { enable: false },
                });

                const deviceState = await OneSignal.getDeviceState();
                if (deviceState && deviceState.userId) {
                    const { updateDoc, doc } = await import("https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js");
                    await updateDoc(doc(db, "users", userUid), {
                        oneSignalPlayerId: deviceState.userId,
                        lastUpdate: new Date().getTime()
                    });
                }
            } catch (err) {
                console.error("OneSignal Error:", err);
            }
        });
    }

    // --- FONCTION POUR ENVOYER (Ã€ utiliser dans chat.html ou quand tu crÃ©es une note) ---
    async function envoyerPush(targetPlayerId, titre, message) {
        const apiKey = "os_v2_app_xse37kmadzf5bilygfagjzcppxcke2r3rfoe2jfgdgtqlv72wfn6uwijbxl7rlpfnc4yodwbszlau6jggtk4iv4kfbssmx46p3h2xbi";

        await fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": "Basic " + apiKey
            },
            body: JSON.stringify({
                app_id: "bc89bfa9-801e-4bd0-a178-314064e44f7d",
                include_player_ids: [targetPlayerId],
                headings: {"fr": titre},
                contents: {"fr": message},
                android_accent_color: "FF0000FF",
                priority: 10 // Pour que Ã§a arrive instantanÃ©ment
            })
        });
    }

    function initMessagesListener(myUid) {
        const qNew = query(collectionGroup(db, "messages"), where("receiverId", "==", myUid));

        // On Ã©coute les changements
        onSnapshot(qNew, () => {
            renderList();
        }, (error) => {
            console.warn("Index manquant ou erreur :", error);
            renderList(); // On essaie quand mÃªme d'afficher le local
        });
    }
    window.deleteChat = (id, event) => {
        event.stopPropagation(); // EmpÃªche d'ouvrir le chat

        const confirmDelete = confirm("Voulez-vous supprimer cette discussion ?");
        if (confirmDelete) {
            const item = document.getElementById(`item-${id}`);
            item.classList.add('removing');

            setTimeout(() => {
                localStorage.removeItem(`chat_history_${id}`);
                localStorage.removeItem(`cache_${id}`);
                renderList(); // RafraÃ®chit la liste
            }, 500);
        }
    };

    // Remplace toute ta fonction renderList() par celle-ci :
    async function renderList() {
        if (isRendering) return;
        isRendering = true;

        const container = document.getElementById('chat-container');
        const emptyState = document.getElementById('empty-state');
        const myUid = auth.currentUser?.uid;

        if (!myUid) { isRendering = false; return; }

        const localKeys = Object.keys(localStorage).filter(k => k.startsWith('chat_history_'));
        let uniqueIds = localKeys.map(k => k.replace('chat_history_', ''));

        // GESTION DE L'AFFICHAGE VIDE
        if (uniqueIds.length === 0) {
            container.innerHTML = "";
            emptyState.style.display = "flex";
            isRendering = false;
            return;
        } else {
            emptyState.style.display = "none";
        }

        uniqueIds.sort((a, b) => {
            const histA = JSON.parse(localStorage.getItem(`chat_history_${a}`) || "[]");
            const histB = JSON.parse(localStorage.getItem(`chat_history_${b}`) || "[]");
            const getT = (h) => {
                if (h.length === 0) return 0;
                const last = h[h.length - 1];
                return last.createdAt?.seconds || new Date(last.createdAt).getTime() / 1000 || 0;
            };
            return getT(histB) - getT(histA);
        });

        const fragment = document.createDocumentFragment();

        for (const id of uniqueIds) {
            const history = JSON.parse(localStorage.getItem(`chat_history_${id}`) || "[]");
            const localCache = JSON.parse(localStorage.getItem(`cache_${id}`) || "{}");
            const lastMsg = history.length > 0 ? history[history.length - 1] : { text: "...", type: "text" };
            const timeStr = lastMsg.createdAt ? formatLastMsgTime(lastMsg.createdAt) : "";

            const item = document.createElement('div');
            item.className = `chat-item`;
            item.id = `item-${id}`;

            // --- GESTION DU CLIC LONG (Suppression) ---
            let timer;
            item.onmousedown = item.ontouchstart = () => {
                timer = setTimeout(() => window.deleteChat(id, event), 800);
            };
            item.onmouseup = item.ontouchend = () => clearTimeout(timer);

            item.onclick = () => window.openChat(id);

            item.innerHTML = `
                <div style="position:relative; width:55px; height:55px; flex-shrink:0;">
                    <img id="img-${id}" src="${localCache.photo || 'https://ui-avatars.com/api/?name=?'}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
                    <div class="online-indicator" id="online-${id}"></div>
                </div>
                <div style="flex:1; overflow:hidden; margin-left:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong id="name-${id}" class="contact-name" style="color:var(--text); font-size:15px;">${localCache.nom || "Utilisateur"}</strong>
                        <span style="font-size:11px; color:var(--gray);">${timeStr}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:4px;">
                        <p style="margin:0; font-size:13px; color:var(--gray); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;">
                            ${lastMsg.type === 'voice' ? 'ðŸŽ¤ Vocal' : (lastMsg.type === 'image' ? 'ðŸ“· Photo' : (lastMsg.text || ''))}
                        </p>
                        <span id="badge-${id}" style="background:var(--myme-blue); color:white; border-radius:50%; min-width:18px; height:18px; display:none; align-items:center; justify-content:center; font-size:10px; font-weight:bold; padding:2px; margin-left:8px;">0</span>
                    </div>
                </div>
            `;
            fragment.appendChild(item);

            getDoc(doc(db, "users", id)).then(snap => {
                if (snap.exists()) {
                    const d = snap.data();
                    const nameEl = document.getElementById(`name-${id}`);
                    const imgEl = document.getElementById(`img-${id}`);
                    if(nameEl) nameEl.textContent = d.prenom + " " + (d.nom || "");
                    if(imgEl) imgEl.src = d.photoURL || imgEl.src;
                    if(d.isOnline) document.getElementById(`item-${id}`)?.classList.add('is-online');
                    localStorage.setItem(`cache_${id}`, JSON.stringify({ nom: d.prenom, photo: d.photoURL }));
                }
            });

            ecouterMessagesNonLus(myUid, id, `badge-${id}`);
        }

        container.innerHTML = "";
        container.appendChild(fragment);
        isRendering = false;
    }

    async function applyTranslations() {
        const lang = localStorage.getItem("lang") || "fr";
        try {
            const res = await fetch("lang.json");
            if (res.ok) {
                const trans = await res.json();
                document.querySelectorAll("[data-lang]").forEach(el => {
                    const key = el.getAttribute("data-lang");
                    if (trans[lang]?.[key]) {
                        if (el.tagName === "INPUT") el.placeholder = trans[lang][key];
                        else el.textContent = trans[lang][key];
                    }
                });
            }
        } catch(e) {}
    }
    function formatLastMsgTime(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    document.getElementById('search-input').oninput = (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('.chat-item').forEach(item => {
            const name = item.querySelector('.contact-name').textContent.toLowerCase();
            item.style.display = name.includes(term) ? 'flex' : 'none';
        });
    };

</script>
</body>

</html>














