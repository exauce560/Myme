<!DOCTYPE html>
<html lang="fr" data-lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Rock+Salt&family=Caveat:wght@400;700&family=Shadows+Into+Light&family=Gochi+Hand&display=swap" rel="stylesheet">
    <title>Myme - Statuts</title>
    
    <style>
        :root {
            --bg: #ffffff; --text: #020c15; --gray: #667781;
            --accent: #ff8c1a; --header-bg: #ffffff; --border: #f0f2f5;
            --app-radius: 15px;
            --app-font-family: 'Segoe UI', system-ui, sans-serif;
            --app-font-size: 14px;
            --sidebar-width: 320px;
        }
        body.dark-mode {
            --bg: #020c15; --text: #e9edef; --gray: #8696a0;
            --header-bg: #020c15; --border: #1a242d;
        }

        /* --- STYLE DES BOUTONS SVG --- */
        .like-btn, .action-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10003;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(5px);
            color: white;
        }

        .like-btn { bottom: 80px; right: 20px; width: 50px; height: 50px; }
        .delete-btn-svg { top: 50px; right: 20px; width: 40px; height: 40px; background: rgba(255, 50, 50, 0.6); display: none; }
        .pause-btn { top: 50px; left: 20px; width: 40px; height: 40px; }

        .like-btn:hover, .action-btn:hover { transform: scale(1.15); background: rgba(255, 255, 255, 0.3); }
        .like-btn svg { fill: white; transition: fill 0.3s, transform 0.2s; }
        .like-btn.liked svg { fill: #ff4b4b; transform: scale(1.2); }

        body { 
            font-family: var(--app-font-family); 
            font-size: var(--app-font-size);
            background: var(--bg); color: var(--text); margin: 0; 
            height: 100vh; overflow: hidden;
            transition: background 0.3s;
        }

        .main-wrapper { display: flex; height: calc(100vh - 65px); width: 100%; }
        .sidebar { width: var(--sidebar-width); border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg); padding: 15px; flex-shrink: 0; box-sizing: border-box; }
        .content-view {
            flex: 1;
            position: relative;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
    
            /* --- AJOUTS POUR L'√âCART --- */
            margin-bottom: 3px; /* √âcart en bas */
            margin-right: 3px;  /* √âcart √† droite */
            border-radius: var(--app-radius); /* Pour arrondir les coins du visionneur */
            overflow: hidden;   /* Pour que le fond flou ne d√©passe pas des coins arrondis */
            height: calc(100vh - 65px - 5px); /* On d√©duit le header (65px) et la marge (5px) */
        }
        .header { padding: 10px 20px; background: var(--header-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; height: 45px; }
        .back-btn { background: none; border: none; padding: 5px; cursor: pointer; color: var(--text); }

        .post-box { background: var(--border); padding: 12px; border-radius: var(--app-radius); margin-bottom: 20px; border: 1px solid transparent; }
        .post-input { width: 100%; border: none; background: transparent; font-size: inherit; color: var(--text); outline: none; font-family: inherit; resize: none; }

        .notes-list { display: flex; flex-direction: column; gap: 10px; }
        .note-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--header-bg); border-radius: var(--app-radius); border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .note-item:hover { background: var(--border); }
        .note-item.active { border-color: var(--accent); background: var(--border); }
        
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        .name { font-weight: 600; font-size: 0.9em; color: var(--text); }

        .story-bg-blur { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(40px) brightness(0.4); z-index: 1; }
        .story-container-inner { position: relative; z-index: 2; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .story-top { padding: 15px; width: 100%; box-sizing: border-box; }
        .progress-container { display: flex; gap: 4px; height: 3px; }
        .prog-bar { flex: 1; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; }
        .prog-fill { width: 0%; height: 100%; background: #fff; }

        .story-main {
            flex: 1; /* Prend tout l'espace restant */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        .story-img { max-width: 90%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .story-text-overlay { position: absolute; bottom: 40px; background: rgba(0,0,0,0.6); color: white; padding: 10px 20px; border-radius: 10px; text-align: center; }
.story-text-content {
    /* --- Ton design visuel conserv√© --- */
    font-family: 'Caveat', cursive;
    background: rgba(255, 255, 255, 0.15) !important; 
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    color: white;
    font-weight: bold;
    text-align: center;
    box-sizing: border-box;

    /* --- Les correctifs pour le texte --- */
    display: flex;
    align-items: center;
    justify-content: center;
    width: 85%;
    max-width: 90%;
    max-height: 70vh; /* Emp√™che de d√©passer sur PC et Mobile */
    padding: 30px;
    font-size: 26px; /* Taille sur PC */
    line-height: 1.2;
    
    /* Gestion du d√©bordement */
    overflow-y: auto; 
    word-wrap: break-word;
    overflow-wrap: break-word;
    
    /* Cache la barre de scroll */
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.story-text-content::-webkit-scrollbar {
    display: none;
}

        .reply-bar {
            padding: 20px; /* Plus d'espace pour ne pas coller au bord */
            padding-bottom: 30px; /* S√©curit√© pour les √©crans d'iPhone (notch bas) */
            display: flex;
            gap: 10px;
            width: 100%;
            box-sizing: border-box;
            z-index: 10003;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent); /* Ombre pour lisibilit√© */
        }

        /* Style pour le compteur de vues/likes (uniquement pour l'auteur) */
.story-stats {
    position: absolute;
    top: 50px; /* Align√© avec le bouton pause/delete */
    left: 70px; /* D√©cal√© pour ne pas cacher le bouton pause */
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    color: white;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 10004;
    border: 1px solid rgba(255,255,255,0.1);
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.stat-item svg {
    width: 16px;
    height: 16px;
    fill: white;
}
#stats-modal {
    position: fixed;
    bottom: -100%; /* Cach√© par d√©faut en bas */
    left: 0;
    width: 100%;
    height: 60%;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 20000;
    border-radius: 25px 25px 0 0;
    padding: 20px;
    box-sizing: border-box;
    transition: bottom 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
    color: #000;
}

.dark-mode #stats-modal {
    background: rgba(2, 12, 21, 0.85);
    color: #fff;
}

#stats-modal.open {
    bottom: 0; /* On l'affiche */
}

.stats-user-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border-radius: 15px;
    transition: background 0.2s;
}

.stats-user-item:hover {
    background: rgba(0,0,0,0.05);
}

.stats-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--accent);
}

.stats-info b {
    display: block;
    font-size: 14px;
}

.stats-info span {
    font-size: 11px;
    color: var(--gray);
}

/* Barre de saisie pour fermer (le petit trait en haut du modal) */
.modal-handle {
    width: 40px;
    height: 5px;
    background: rgba(0,0,0,0.1);
    border-radius: 10px;
    margin: 0 auto 15px auto;
    cursor: pointer;
}
/* Am√©lioration de la l√©gende sur photo */
.story-text-overlay {
    position: absolute;
    bottom: 100px; /* Remont√© pour ne pas g√™ner la barre de r√©ponse */
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    max-width: 80%;
    word-wrap: break-word;
    font-family: var(--app-font-family);
    font-size: 16px;
}        
        .reply-input {
            flex: 1;
            border-radius: 20px; /* Arrondi √† 45px pour l'effet pilule */
            border: 2px solid #ffffff !important; /* Bordure blanche de 2px */
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2); /* Transparence */
            color: white;
            outline: none;
            backdrop-filter: blur(10px); /* Flou derri√®re la barre pour la lisibilit√© */
        }
        
        #file-status {
            font-size: 12px;
            color: #29bd49;
            margin: 8px 0;
            display: none;
            align-items: center;
            gap: 5px;
        }
        .empty-state { color: white; text-align: center; z-index: 2; }
        /* Style pour le conteneur de texte avec d√©grad√© */
        .story-text-content.has-gradient {
            width: 85%;
            max-height: 60vh; /* R√©duit pour laisser de la place √† la barre de texte */
            aspect-ratio: auto; /* Plus flexible que 9/16 pour les longs textes */
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
            border-radius: 30px;
            background: var(--story-gradient) !important;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 45px rgba(0,0,0,0.5);
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Flou de fond dynamique */
        .story-bg-blur.text-mode {
            background: var(--story-gradient);
            filter: blur(80px) brightness(0.5);
            transform: scale(1.2); /* √âvite les bords blancs lors du flou */
        }
/* Conteneur de la r√©ponse √† l'int√©rieur de la bulle de chat */
.reply-context-container {
    background: rgba(0, 0, 0, 0.1);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 100%;
}

.dark-mode .reply-context-container {
    background: rgba(255, 255, 255, 0.1);
}

.reply-miniature {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
    flex-shrink: 0;
}

.reply-text-preview {
    font-size: 0.85em;
    color: var(--gray);
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Coupe le texte apr√®s 2 lignes */
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.2;
}
        /* Style des fl√®ches de navigation */
.nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.2);
    border: none;
    color: white;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10004; /* Au-dessus du contenu */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
}

.nav-arrow:hover {
    background: rgba(255, 255, 255, 0.2);
}

.arrow-left { left: 15px; }
.arrow-right { right: 15px; }

        @media (max-width: 768px) {
            .story-text-content {
                font-size: 1.3rem; /* R√©duit la taille pour que 300 caract√®res rentrent mieux */
                padding: 20px;
                max-height: 60vh; /* Laisse de la place pour les stats en bas */
                width: 90%;
            }
            .nav-arrow { width: 40px; height: 40px; background: rgba(0, 0, 0, 0.1); }
            .sidebar { width: 100%; border-right: none; }
            .content-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
            .content-view.active { display: flex; }
            .close-story-mobile { display: block; position: absolute; top: 35px; right: 20px; z-index: 10005; color: white; font-size: 30px; cursor: pointer; }
        }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="window.history.back()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </button>
        <h2 style="margin:0; font-size: 18px;">Statuts</h2>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div class="post-box" id="post-box">
                <textarea id="note-text" class="post-input" rows="2" placeholder="Quoi de neuf ?" maxlength="300"></textarea>
                <div id="file-status">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <span>Image s√©lectionn√©e</span>
                </div>
                <div style="display:flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                    <input type="file" id="note-file" hidden onchange="handleFileSelect(this)">
                    <button onclick="document.getElementById('note-file').click()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:12px; font-weight:bold;">+ IMAGE</button>
                    <button onclick="publishNote()" style="background: #29bd49; color:white; border:none; padding:6px 15px; border-radius:15px; cursor:pointer; font-size:12px; font-weight:600;">PUBLIER</button>
                </div>
            </div>
            <div id="notes-list" class="notes-list"></div>
        </div>

        <div id="post-viewer" class="content-view">
            <div id="story-blur-bg" class="story-bg-blur"></div>
            <span class="close-story-mobile" onclick="closeStory()">&times;</span>
            <div id="empty-msg" class="empty-state">
                <p>S√©lectionnez un contact pour voir son statut</p>
            </div>
            
            <div id="story-content" class="story-container-inner" style="display: none;">
                <button id="pause-btn" class="action-btn pause-btn" onclick="toggleTimer()">
                    <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
                </button>

                <button id="delete-story-btn" class="action-btn delete-btn-svg" onclick="deleteCurrentStory()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
                
                <button id="like-btn" class="like-btn" onclick="sendLike()" title="Aimer ce statut">
                    <svg width="24" height="24" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <button class="nav-arrow arrow-left" onclick="prevStory()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>

                <button class="nav-arrow arrow-right" onclick="nextStory()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>

                <div class="story-top"><div class="progress-container" id="prog-container"></div></div>
                <div class="story-main" id="story-main-zone"></div>
                
                <div class="reply-bar" id="story-reply-bar">
                    <input type="text" id="reply-text" class="reply-input" placeholder="R√©pondre..." onkeypress="if(event.key === 'Enter') sendReply()">
                    <button onclick="sendReply()" style="background: #29bd49; border:none; color:white; border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="stats-modal" style="display:none; position:fixed; bottom:0; left:0; width:100%; height:70%; background:var(--bg); z-index:20000; border-top-radius:20px; padding:20px; box-sizing:border-box; overflow-y:auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="modal-title" style="margin:0;">Vues</h3>
            <button onclick="closeStats()" style="background:none; border:none; font-size:24px; color:var(--text);">&times;</button>
        </div>
        <div id="stats-list"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDoc, doc, where, getDocs, serverTimestamp, deleteDoc, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA3YTGXBA9Cf9QNaGau0PCBgyuGSJv5pi0",
        authDomain: "myme-31f3c.firebaseapp.com",
        projectId: "myme-31f3c",
        storageBucket: "myme-31f3c.firebasestorage.app",
        messagingSenderId: "598768810366",
        appId: "1:598768810366:web:b401c77010102e8988db2f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentStories = [];
    let storyIdx = 0;
    let timer;
    let progress = 0;
    let isPaused = false;

    // --- SYNCHRO STYLE ---
    window.syncMymeStyle = function() {
        const fs = localStorage.getItem('myme-fsize') || '16px';
        const ff = localStorage.getItem('myme-ffam') || "'Segoe UI'";
        const rad = localStorage.getItem('myme-radius') || '20px';
        const theme = localStorage.getItem('theme');
        document.documentElement.style.setProperty('--app-font-size', fs);
        document.documentElement.style.setProperty('--app-font-family', ff);
        document.documentElement.style.setProperty('--app-radius', rad);
        if (theme === 'dark') document.body.classList.add('dark-mode');
        else document.body.classList.remove('dark-mode');
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) return;
        currentUser = user;
        cleanupOldNotes(); // Supprime les vieux statuts √† la connexion
        loadProfiles();
        window.syncMymeStyle();
    });

    // --- FONCTION DE NETTOYAGE (SUR LE SERVEUR) ---
    async function cleanupOldNotes() {
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        const q = query(collection(db, "notes"), where("createdAt", "<", Timestamp.fromMillis(twentyFourHoursAgo)));
        const snap = await getDocs(q);
        snap.forEach(async (d) => {
            await deleteDoc(doc(db, "notes", d.id));
            console.log("Statut expir√© supprim√© :", d.id);
        });
    }
    window.likeStatus = async (statusId, ownerUid, ownerPlayerId) => {
    const myUid = auth.currentUser.uid;
    const myName = localStorage.getItem('myme-user-name') || "Quelqu'un";
    
    try {
        const likeRef = doc(db, "status", statusId, "likes", myUid);
        
        // 1. Ajouter le like dans Firestore
        await setDoc(likeRef, {
            likedAt: serverTimestamp(),
            userUid: myUid
        });

        // 2. Envoyer la notification via ta fonction envoyerPush
        if (ownerPlayerId && ownerUid !== myUid) {
            envoyerPush(
                ownerPlayerId, 
                "Nouveau Like ! ‚ù§Ô∏è", 
                `${myName} a aim√© votre statut.`
            );
        }
        
        console.log("Statut lik√© !");
    } catch (e) {
        console.error("Erreur like:", e);
    }
};
    window.addComment = async (statusId, ownerUid, ownerPlayerId, commentText) => {
    if (!commentText.trim()) return;
    
    const myUid = auth.currentUser.uid;
    const myName = localStorage.getItem('myme-user-name') || "Un utilisateur";

    try {
        // 1. Enregistrer le commentaire
        await addDoc(collection(db, "status", statusId, "comments"), {
            text: commentText,
            senderId: myUid,
            senderName: myName,
            createdAt: serverTimestamp()
        });

        // 2. Notifier le propri√©taire
        if (ownerPlayerId && ownerUid !== myUid) {
            envoyerPush(
                ownerPlayerId, 
                "Nouveau commentaire üí¨", 
                `${myName} a dit : ${commentText}`
            );
        }

        window.showToast("Commentaire envoy√© !");
    } catch (e) {
        console.error("Erreur commentaire:", e);
    }
};
    // --- CHARGEMENT (FILTR√â 24H) ---
    function loadProfiles() {
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        // On ne prend que ce qui est r√©cent
        const q = query(
            collection(db, "notes"), 
            where("createdAt", ">=", Timestamp.fromMillis(twentyFourHoursAgo)),
            orderBy("createdAt", "desc")
        );

        onSnapshot(q, async (snap) => {
            const list = document.getElementById('notes-list');
            list.innerHTML = "";
            const usersSeen = new Set();
            for (const d of snap.docs) {
                const data = d.data();
                if (usersSeen.has(data.authorId)) continue;
                usersSeen.add(data.authorId);
                const uSnap = await getDoc(doc(db, "users", data.authorId));
                if (!uSnap.exists()) continue;
                const uData = uSnap.data();
                const item = document.createElement('div');
                item.className = "note-item";
                item.onclick = () => openUserStories(data.authorId);
                item.innerHTML = `
                    <img src="${uData.photoURL || 'https://ui-avatars.com/api/?name=' + uData.prenom}" class="avatar">
                    <div class="name">${uData.prenom || ''} ${uData.nom || 'User'}</div>
                `;
                list.appendChild(item);
            }
        });
    }
// Fonction pour passer au statut suivant
window.nextStory = () => {
    clearInterval(timer); // Arr√™te le chrono actuel
    storyIdx++;
    if (storyIdx < currentStories.length) {
        showStory();
    } else {
        window.closeStory(); // Ferme si c'√©tait le dernier
    }
};

// Fonction pour revenir au statut pr√©c√©dent
window.prevStory = () => {
    clearInterval(timer);
    if (storyIdx > 0) {
        storyIdx--;
        showStory();
    } else {
        // Optionnel : Recommencer le premier statut si on clique √† gauche au d√©but
        progress = 0;
        showStory();
    }
};
    // --- INTERACTIONS MESSAGES ---
window.sendLike = async () => {
    const story = currentStories[storyIdx];
    if (!story || !currentUser || story.authorId === currentUser.uid) return;

    const myUid = currentUser.uid;
    const targetUid = story.authorId;
    const chatId = myUid < targetUid ? myUid + "_" + targetUid : targetUid + "_" + myUid;
    const miniature = story.photoBase64 
        ? `<img src="${story.photoBase64}" style="width: 45px; height: 45px; border-radius: 8px; object-fit: cover;">`
        : `<div style="width: 45px; height: 45px; border-radius: 8px; background: linear-gradient(135deg, #ff8c1a, #ff4b4b); color: white; font-size: 8px; display: flex; align-items: center; justify-content: center; padding: 4px; overflow: hidden; text-align: center; line-height: 1;">${story.texte.substring(0, 20)}...</div>`;

    // On pr√©pare un HTML sp√©cifique que le chat affichera
    // Le style 'pointer-events: none' emp√™che de copier le texte facilement
    const customLikeHTML = `
        <div style="display: flex; align-items: center; gap: 12px; background: rgba(255,140,26,0.1); padding: 10px; border-radius: 15px; border-left: 5px solid #ff8c1a; pointer-events: none; user-select: none;">
            ${miniature}
            <div style="font-size: 13px; color: var(--text);">
                <b style="color: #ff8c1a; display: block; font-size: 11px; text-transform: uppercase;">‚ù§Ô∏è Like</b>
                A aim√© votre ${story.photoBase64 ? 'photo' : 'statut'}
            </div>
        </div>`;

    try {
        await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: myUid,
            receiverId: targetUid,
            text: customLikeHTML, // On envoie le HTML directement dans le champ texte
            type: 'text', // On laisse 'text' pour que ton chat l'affiche sans modif
            createdAt: serverTimestamp(),
            read: false
        });

        // Mise √† jour de l'aper√ßu (lastMessage) sans le code HTML pour que ce soit propre dans la liste des discussions
        await setDoc(doc(db, "chats", chatId), {
            lastMessage: "‚ù§Ô∏è a aim√© votre statut",
            lastTimestamp: serverTimestamp(),
            participants: [myUid, targetUid]
        }, { merge: true });

        // Animation bouton
        const btn = document.getElementById('like-btn');
        btn.classList.add('liked');
        setTimeout(() => btn.classList.remove('liked'), 1000);
        
    } catch (e) { console.error("Erreur Like:", e); }
};

window.sendReply = async () => {
    const replyInput = document.getElementById('reply-text');
    const replyText = replyInput.value.trim();
    const story = currentStories[storyIdx];

    if (!replyText || !story || !currentUser) return;

    const myUid = currentUser.uid;
    const targetUid = story.authorId;
    const chatId = myUid < targetUid ? myUid + "_" + targetUid : targetUid + "_" + myUid;

    // Structure de la r√©ponse avec la photo pr√©cise √† laquelle on r√©pond
    const customReplyHTML = `
        <div style="margin-bottom: 8px; user-select: none;">
            <div style="display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.05); padding: 6px; border-radius: 8px; border-left: 3px solid #29bd49; margin-bottom: 5px;">
                <img src="${story.photoBase64 || 'https://cdn-icons-png.flaticon.com/512/2593/2593491.png'}" 
                     style="width: 30px; height: 30px; border-radius: 4px; object-fit: cover;">
                <span style="font-size: 11px; color: #666; font-style: italic;">En r√©ponse √† ce statut</span>
            </div>
            <div style="font-size: 14px;">${replyText}</div>
        </div>`;

    try {
        await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: myUid,
            receiverId: targetUid,
            text: customReplyHTML,
            type: 'text',
            createdAt: serverTimestamp(),
            read: false
        });

        await setDoc(doc(db, "chats", chatId), {
            lastMessage: `üí¨ ${replyText}`,
            lastTimestamp: serverTimestamp(),
            participants: [myUid, targetUid]
        }, { merge: true });

        replyInput.value = "";
    } catch (e) { console.error("Erreur r√©ponse:", e); }
};

    // --- LOGIQUE STORY (IMAGE/TEXTE) ---
    async function openUserStories(userId) {
        const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
        const q = query(
            collection(db, "notes"), 
            where("authorId", "==", userId),
            where("createdAt", ">=", Timestamp.fromMillis(twentyFourHoursAgo))
        );
        const snap = await getDocs(q);
        currentStories = snap.docs.map(d => ({ id: d.id, ...d.data() }))
            .sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
        
        if(currentStories.length === 0) return;
        storyIdx = 0;
        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('story-content').style.display = 'flex';
        document.getElementById('post-viewer').classList.add('active');
        showStory();
    }

    window.showStory = function() {
        if (storyIdx >= currentStories.length) return window.closeStory();
        const story = currentStories[storyIdx];
        const mainZone = document.getElementById('story-main-zone');
        const blurBg = document.getElementById('story-blur-bg');
        
        const gradients = [
            "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",
            "linear-gradient(135deg, #FF512F 0%, #DD2476 100%)",
            "linear-gradient(135deg, #12c2e9 0%, #c471ed 50%, #f64f59 100%)",
            "linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%)",
            "linear-gradient(135deg, #f89b29 0%, #ff0f7b 100%)"
        ];

        const isMine = story.authorId === currentUser.uid;
        document.getElementById('delete-story-btn').style.display = isMine ? 'flex' : 'none';
        document.getElementById('like-btn').style.display = isMine ? 'none' : 'flex';

        if (story.photoBase64) {
            blurBg.classList.remove('text-mode');
            blurBg.style.backgroundImage = `url(${story.photoBase64})`;
            mainZone.innerHTML = `<img src="${story.photoBase64}" class="story-img">${story.texte ? `<div class="story-text-overlay">${story.texte}</div>` : ''}`;
        } else {
            const gradIndex = Math.floor(Math.random() * gradients.length);
            document.documentElement.style.setProperty('--story-gradient', gradients[gradIndex]);
            blurBg.style.backgroundImage = "none";
            blurBg.classList.add('text-mode');
            mainZone.innerHTML = `<div class="story-text-content has-gradient">${story.texte}</div>`;
        }

        // Vues et Stats
        if (!isMine) {
            setDoc(doc(db, "notes", story.id, "views", currentUser.uid), { viewedAt: serverTimestamp() });
        } else {
            // On calcule le total pour TOUS les statuts affich√©s de cet utilisateur
            let totalViews = 0;
            let totalLikes = 0;

            // On boucle sur tous les documents charg√©s dans currentStories
            const promises = currentStories.map(async (s) => {
                const vSnap = await getDocs(collection(db, "notes", s.id, "views"));
                const lSnap = await getDocs(collection(db, "notes", s.id, "likes"));
                return { views: vSnap.size, likes: lSnap.size };
            });

            Promise.all(promises).then(results => {
                results.forEach(res => {
                    totalViews += res.views;
                    totalLikes += res.likes;
                });

                const existingStats = document.querySelector('.story-stats');
                if(existingStats) existingStats.remove();

                // Insertion avec SVG au lieu d'√©mojis
                mainZone.insertAdjacentHTML('beforeend', `
                    <div class="story-stats">
                        <div class="stat-item" onclick="openStatsList('${story.id}', 'views')">
                            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            <span id="count-views">0</span>
                        </div>
                        <div class="stat-item" onclick="openStatsList('${story.id}', 'likes')">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span id="count-likes">0</span>
                        </div>
                    </div>
                `);

                // √âcoute en temps r√©el pour CE statut pr√©cis
                onSnapshot(collection(db, "notes", story.id, "views"), snap => document.getElementById('count-views').innerText = snap.size);
                onSnapshot(collection(db, "notes", story.id, "likes"), snap => document.getElementById('count-likes').innerText = snap.size);
            });
        }

        progress = 0;
        isPaused = false;
        updatePauseIcon();
        setupProgressBars();
        startTimer();
    };

    function startTimer() {
        clearInterval(timer);
        const fills = document.querySelectorAll('.prog-fill');
        timer = setInterval(() => {
            if (!isPaused && fills[storyIdx]) {
                progress += 0.5; // Vitesse fluide
                fills[storyIdx].style.width = progress + "%";
                if (progress >= 100) { clearInterval(timer); storyIdx++; showStory(); }
            }
        }, 30);
    }

    window.toggleTimer = () => { isPaused = !isPaused; updatePauseIcon(); };

    function updatePauseIcon() {
        const icon = document.getElementById('pause-icon');
        icon.innerHTML = isPaused ? '<path d="M8 5v14l11-7z"></path>' : '<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>';
    }

    function setupProgressBars() {
        const container = document.getElementById('prog-container');
        container.innerHTML = "";
        currentStories.forEach((_, i) => {
            const bar = document.createElement('div');
            bar.className = "prog-bar";
            const fill = document.createElement('div');
            fill.className = "prog-fill";
            if (i < storyIdx) fill.style.width = "100%";
            bar.appendChild(fill);
            container.appendChild(bar);
        });
    }

    window.closeStory = () => {
        clearInterval(timer);
        document.getElementById('story-content').style.display = 'none';
        document.getElementById('empty-msg').style.display = 'block';
        document.getElementById('post-viewer').classList.remove('active');
    };

    window.deleteCurrentStory = async () => {
        if (!confirm("Supprimer ce statut ?")) return;
        await deleteDoc(doc(db, "notes", currentStories[storyIdx].id));
        currentStories.splice(storyIdx, 1);
        if (currentStories.length === 0) window.closeStory(); else showStory();
    };
    window.openStatsList = async (storyId, collectionName) => {
    const modal = document.getElementById('stats-modal');
    const list = document.getElementById('stats-list');
    const title = document.getElementById('modal-title');
    
    title.innerText = collectionName === 'views' ? 'Vues du statut' : 'Likes du statut';
    list.innerHTML = `<div style="text-align:center; padding:20px;">Chargement...</div>`;
    
    // Animation d'ouverture
    modal.style.display = 'block';
    setTimeout(() => modal.classList.add('open'), 10);
    
    isPaused = true; 
    updatePauseIcon();

    const snap = await getDocs(collection(db, "notes", storyId, collectionName));
    list.innerHTML = "";
    
    if (snap.empty) {
        list.innerHTML = `<div style="text-align:center; color:gray; margin-top:20px;">Personne pour l'instant</div>`;
        return;
    }

    for (const d of snap.docs) {
        const uSnap = await getDoc(doc(db, "users", d.id)); 
        if (uSnap.exists()) {
            const u = uSnap.data();
            const timeData = d.data().viewedAt || d.data().likedAt;
            const timeStr = timeData ? timeData.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "R√©cemment";
            
            list.innerHTML += `
                <div class="stats-user-item">
                    <img src="${u.photoURL || 'https://ui-avatars.com/api/?name='+u.prenom}" class="stats-avatar">
                    <div class="stats-info">
                        <b>${u.prenom} ${u.nom || ''}</b>
                        <span>Vu √† ${timeStr}</span>
                    </div>
                </div>`;
        }
    }
};

window.closeStats = () => {
    const modal = document.getElementById('stats-modal');
    modal.classList.remove('open');
    setTimeout(() => {
        modal.style.display = 'none';
        isPaused = false;
        startTimer(); // Relance le d√©filement du statut
    }, 400);
};

    window.publishNote = async () => {
    const text = document.getElementById('note-text').value;
    const fileInput = document.getElementById('note-file');
    const file = fileInput.files[0];
    const btn = event.currentTarget; // S√©curisation du bouton
    
    if (!text && !file) return;
    
    btn.disabled = true;
    const oldText = btn.innerText;
    btn.innerText = "...";

    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = async () => {
                // --- LOGIQUE DE COMPRESSION ---
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const max_size = 1080; // Taille max (HD)

                if (width > height) {
                    if (width > max_size) { height *= max_size / width; width = max_size; }
                } else {
                    if (height > max_size) { width *= max_size / height; height = max_size; }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compression √† 0.7 (70% de qualit√©, id√©al pour le web)
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                
                await saveToDB(text, compressedBase64);
                btn.disabled = false;
                btn.innerText = oldText;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    } else {
        await saveToDB(text, "");
        btn.disabled = false;
        btn.innerText = oldText;
    }
};

async function saveToDB(t, img) {
    try {
        await addDoc(collection(db, "notes"), { 
            authorId: currentUser.uid, 
            texte: t, 
            photoBase64: img, 
            createdAt: serverTimestamp() 
        });
        // R√©initialisation interface
        document.getElementById('note-text').value = "";
        document.getElementById('note-file').value = "";
        document.getElementById('file-status').style.display = 'none';
    } catch (e) {
        console.error("Erreur de publication:", e);
        alert("Oups, impossible de publier.");
    }
}

    window.handleFileSelect = (i) => {
        const status = document.getElementById('file-status');
        if (i.files && i.files[0]) {
            status.style.display = 'flex'; // Utilise flex pour aligner le SVG et le texte
        } else {
            status.style.display = 'none';
        }
    };
</script>
</body>
</html>






